# –£–õ–£–ß–®–ï–ù–ò–ï –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò –ë–î - ROLLBACK –¢–†–ê–ù–ó–ê–ö–¶–ò–ô

**–î–∞—Ç–∞:** 07.08.2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

## üéØ –¶–µ–ª—å

–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∏ –æ—Ç–∫–∞—Ç –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ `DatabaseManager.acquire_connection()` –ø–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤ –ø—É–ª.

## üîß –ò–∑–º–µ–Ω–µ–Ω–∏—è

### DatabaseManager.acquire_connection()

–î–æ–±–∞–≤–ª–µ–Ω –±–ª–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ —Å–µ–∫—Ü–∏–∏ `finally`:

```python
# –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
try:
    if getattr(conn, "in_transaction", False):
        await conn.rollback()
except Exception as e:
    logger.warning(f"Rollback failed: {e}")
```

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –ü–µ—Ä–µ–¥ `conn.row_factory = None` –∏ –ª–æ–≥–∏–∫–æ–π –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –ø—É–ª

## üõ°Ô∏è –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ë–î:** –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
2. **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ø—É–ª–∞:** –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ "—á–∏—Å—Ç–æ–º" —Å–æ—Å—Ç–æ—è–Ω–∏–∏
3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –æ—Ç–∫–∞—Ç–æ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
4. **–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å:** Graceful handling –æ—à–∏–±–æ–∫ rollback

## üìã –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- **–§–∞–π–ª:** `bot/database/operations.py`
- **–ú–µ—Ç–æ–¥:** `DatabaseManager.acquire_connection()`
- **–ü–æ–∑–∏—Ü–∏—è:** –°—Ç—Ä–æ–∫–∏ 127-132 (–≤ finally –±–ª–æ–∫–µ)
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** WARNING —É—Ä–æ–≤–µ–Ω—å –¥–ª—è –æ—à–∏–±–æ–∫ rollback

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ–≤—ã—à–µ–Ω–∞ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∏ –ø—É–ª–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π. –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω—ã –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å "–≤–∏—Å—è—â–∏–º–∏" —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏.
