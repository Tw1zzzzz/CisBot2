# –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –í–ï–†–ò–§–ò–ö–ê–¶–ò–û–ù–ù–´–• –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ï–í v2

**–î–∞—Ç–∞:** 07.01.2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û  
**–§–∞–π–ª—ã:** `bot/database/operations.py`

## üìã –û–ë–ó–û–†

–ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è 6 –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö CIS FINDER Bot.

## ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–ù–´–ï –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò

### Comment 1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –æ—Ç–∫–∞—Ç –≤ finally –±–ª–æ–∫–µ
**–ü—Ä–æ–±–ª–µ–º–∞:** Rollback –≤ finally –ø–æ–º–µ—á–∞–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è ¬´–Ω–µ–∑–¥–æ—Ä–æ–≤—ã–º–∏¬ª –∏ –≤—ã–∑—ã–≤–∞–ª –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –∑–∞–º–µ–Ω—É.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –î–û
try:
    await conn.rollback()
except Exception as e:
    logger.warning(f"Rollback failed: {e}")
    connection_is_healthy = False

# –ü–û–°–õ–ï
try:
    if getattr(conn, "in_transaction", False):
        await conn.rollback()
except Exception as e:
    logger.debug(f"No rollback needed or rollback failed: {e}")
    # –ù–ï –ø–æ–º–µ—á–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ–∑–¥–æ—Ä–æ–≤—ã–º –∏–∑-–∑–∞ –æ—Ç–∫–∞—Ç–∞
```

### Comment 2: –£—Ç–æ—á–Ω–µ–Ω –¥–µ—Ç–µ–∫—Ç–æ—Ä —Å–ª–æ–º–∞–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
**–ü—Ä–æ–±–ª–µ–º–∞:** –°–ª–∏—à–∫–æ–º –æ–±—â–∏–π –¥–µ—Ç–µ–∫—Ç–æ—Ä ¬´—Å–ª–æ–º–∞–Ω–Ω—ã—Ö¬ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –ø–æ —Å—Ç—Ä–æ–∫–µ 'connection'.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –î–û
['database is locked', 'connection', 'closed', 'broken']

# –ü–û–°–õ–ï
['database is locked', 'cannot operate on a closed database', 'closed']
```

### Comment 3: –î–æ–±–∞–≤–ª–µ–Ω–æ —è–≤–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∞–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
**–ü—Ä–æ–±–ª–µ–º–∞:** –ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—É–ª–∞ –≤ acquire_connection –º–æ–≥–ª–æ —Å–∫—Ä—ã—Ç—å –æ—à–∏–±–∫–∏ –∏ —É—Å–ª–æ–∂–Ω–∏—Ç—å lifecycle.

**–†–µ—à–µ–Ω–∏–µ:**
```python
if not self._is_connected:
    logger.warning("Pool not initialized; calling connect() implicitly. Consider explicit db.connect() in startup.")
    if self._closing:
        raise RuntimeError("Cannot auto-connect while DatabaseManager is closing")
    await self.connect()
```

### Comment 4: –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
**–ü—Ä–æ–±–ª–µ–º–∞:** –†–∏—Å–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –Ω–∞ writes.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_execute_with_retry()` —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff:
```python
async def _execute_with_retry(self, func, *args, max_retries=3, **kwargs):
    for attempt in range(max_retries):
        try:
            return await func(*args, **kwargs)
        except (sqlite3.OperationalError, aiosqlite.OperationalError) as e:
            if "database is locked" in str(e).lower() and attempt < max_retries - 1:
                delay = (50 * (2 ** attempt)) / 1000  # 50ms, 100ms, 200ms
                jitter = random.uniform(0.8, 1.2)  # ¬±20% –¥–∂–∏—Ç—Ç–µ—Ä
                sleep_time = delay * jitter
                
                logger.warning(f"Database locked, retry {attempt + 1}/{max_retries} after {sleep_time:.3f}s: {e}")
                await asyncio.sleep(sleep_time)
                continue
            else:
                raise
```

### Comment 5: –û–±–µ—Å–ø–µ—á–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫—É—Ä—Å–æ—Ä–æ–≤
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–Ω—Ç—Ä–æ–ª—å row_factory —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤–µ—Ä–Ω–æ, –Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–ø—É—Å–∫–∏ –ø—Ä–∏ —Ä–∞–Ω–Ω–µ–º –≤—ã—Ö–æ–¥–µ.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω `await cursor.close()` –≤ –º–µ—Ç–æ–¥—ã:
- `get_user()`
- `has_profile()`
- `get_profile()`
- `check_mutual_like()`
- `get_user_settings()`

### Comment 6: –ó–∞–º–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∑–∞–∏–º–Ω–æ–≥–æ –ª–∞–π–∫–∞ –Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é
**–ü—Ä–æ–±–ª–µ–º–∞:** –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∑–∞–∏–º–Ω–æ–≥–æ –ª–∞–π–∫–∞ –º–æ–≥–ª–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º –ø–æ–∏—Å–∫–µ.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ó–∞–º–µ–Ω–∏–ª `_check_mutual_like_sync()` –Ω–∞ `_check_mutual_like_async()`
2. –°–¥–µ–ª–∞–ª `_check_privacy_visibility()` –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º
3. –û–±–Ω–æ–≤–∏–ª –≤—ã–∑–æ–≤—ã –≤ `find_candidates()` –∏ `_find_top_1000_candidates()` –Ω–∞ `await`

```python
# –î–û (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π)
def _check_mutual_like_sync(self, user1_id: int, user2_id: int) -> bool:
    import sqlite3
    with sqlite3.connect(self.db_path) as db:
        # ... –∫–æ–¥ ...

# –ü–û–°–õ–ï (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π)
async def _check_mutual_like_async(self, user1_id: int, user2_id: int) -> bool:
    async with self.acquire_connection() as db:
        cursor = await db.execute("""...""")
        row = await cursor.fetchone()
        await cursor.close()
        return row[0] > 0 if row else False
```

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢–´

### ‚úÖ –£–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
- –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –ª–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è health check
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º –ë–î
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–æ–∏—Å–∫ —Å –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å—é
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞–º–∏

### ‚úÖ –£–ª—É—á—à–µ–Ω–∏—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏:
- –¢–æ—á–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∞–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
- –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff –¥–ª—è retry
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤

### ‚úÖ –£–ª—É—á—à–µ–Ω–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:
- –ë–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –ª–æ–≥–∏
- –ß–µ—Ç–∫–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
- –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫

## üîó –°–í–Ø–ó–ê–ù–ù–´–ï –§–ê–ô–õ–´

- **[DATABASE_VERIFICATION_COMMENTS_IMPLEMENTED.md](DATABASE_VERIFICATION_COMMENTS_IMPLEMENTED.md)** - –ü–µ—Ä–≤–∞—è –≤–µ—Ä—Å–∏—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ (11 –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤)
- **[DATABASE_CONNECTION_HEALTH_CHECK.md](DATABASE_CONNECTION_HEALTH_CHECK.md)** - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- **[DATABASE_ROLLBACK_IMPROVEMENT.md](DATABASE_ROLLBACK_IMPROVEMENT.md)** - –£–ª—É—á—à–µ–Ω–∏—è –æ—Ç–∫–∞—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

## üí° –ò–¢–û–ì–ò

–í—Å–µ 6 –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ —É—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–µ–ø–µ—Ä—å –∏–º–µ–µ—Ç:
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –û–ø—Ç–∏–º–∞–ª—å–Ω—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏
- –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ

**–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞:** –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞ –∫ production —Å enterprise-—É—Ä–æ–≤–Ω–µ–º –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏! üöÄ
