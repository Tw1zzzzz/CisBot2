# DATABASE POOL CLEANUP –£–õ–£–ß–®–ï–ù

## –î–∞—Ç–∞: 05.08.2025, 19:30

## üéØ –ü—Ä–æ–±–ª–µ–º–∞
–í `DatabaseManager.disconnect()` –±—ã–ª–∞ –Ω–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–Ω–Ω–µ–≥–æ –≤—ã—Ö–æ–¥–∞:
- –£—Å–ª–æ–≤–∏–µ `if not self._is_connected or not self._pool: return` —Å–æ–∑–¥–∞–≤–∞–ª–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Ñ–ª–∞–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –ü—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ `_is_connected` –Ω–∞—Ö–æ–¥–∏–ª–æ—Å—å –≤–Ω—É—Ç—Ä–∏ —É—Å–ª–æ–≤–∏—è –≤—ã—Ö–æ–¥–∞
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –º–µ–∂–¥—É `connect()` –∏ `disconnect()` –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –°–æ–∑–¥–∞–Ω –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –º–µ—Ç–æ–¥ `_drain_and_close_pool()`
```python
async def _drain_and_close_pool(self):
    """–ó–∞–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤ –ø—É–ª–µ"""
    if not self._pool:
        return
    
    try:
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–µ—Ä–µ–¥ –¥—Ä–µ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—á–µ—Ä–µ–¥–∏
        self._closing = True
        
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        while not self._pool.empty():
            try:
                conn = self._pool.get_nowait()
                await conn.close()
            except asyncio.QueueEmpty:
                break
            except Exception as e:
                logger.warning(f"–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: {e}")
        
        # –û—á–∏—â–∞–µ–º –ø—É–ª
        self._pool = None
        logger.info("–ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∑–∞–∫—Ä—ã—Ç")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π: {e}")
```

### 2. –£–ø—Ä–æ—â–µ–Ω –º–µ—Ç–æ–¥ `disconnect()`
```python
async def disconnect(self):
    """–ó–∞–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤ –ø—É–ª–µ"""
    async with self._lock:
        if not self._pool:
            return
        
        await self._drain_and_close_pool()
        self._is_connected = False
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `connect()` 
```python
# –í –±–ª–æ–∫–µ except:
except Exception as e:
    logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π: {e}")
    await self._drain_and_close_pool()  # –í–º–µ—Å—Ç–æ self.disconnect()
    raise
```

## üìã –ò–∑–º–µ–Ω–µ–Ω–∏—è

### ‚úÖ –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:
1. **–†–∞–Ω–Ω–µ–µ —É—Å–ª–æ–≤–∏–µ –≤—ã—Ö–æ–¥–∞:** `if not self._pool: return` (—É–±—Ä–∞–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç `_is_connected`)
2. **–í—ã–Ω–µ—Å–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞:** –õ–æ–≥–∏–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ `_drain_and_close_pool()`
3. **–§–ª–∞–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è:** `_is_connected = False` —Ç–µ–ø–µ—Ä—å –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –ü–û–°–õ–ï –æ—á–∏—Å—Ç–∫–∏
4. **–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –ú–µ—Ç–æ–¥ `_drain_and_close_pool()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `connect()` –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å:** –õ–æ–≥–∏–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ø—É–ª–∞ –≤—ã–¥–µ–ª–µ–Ω–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥
- **–ò–∑–±–µ–≥–∞–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫:** –í `connect()` –±–æ–ª—å—à–µ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `disconnect()` (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)
- **–ß–µ—Ç–∫–æ—Å—Ç—å:** –†–∞–Ω–Ω–µ–µ —É—Å–ª–æ–≤–∏–µ –≤—ã—Ö–æ–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞–ª–∏—á–∏–µ –ø—É–ª–∞
- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** –ü—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ —Ñ–ª–∞–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏

## üîç –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É–ª–∞:** `if not self._pool: return`
2. **–û—á–∏—Å—Ç–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π:** `await self._drain_and_close_pool()`
3. **–°–±—Ä–æ—Å —Ñ–ª–∞–≥–∞:** `self._is_connected = False`

### –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞:
- –ú–µ—Ç–æ–¥ `_drain_and_close_pool()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `if not self._pool: return`
- –ü–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ `self._pool = None`, —á—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—á–∏—Å—Ç–∫—É

## ‚úÖ –°—Ç–∞—Ç—É—Å
**–†–ï–ê–õ–ò–ó–û–í–ê–ù–û** - –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–π–¥–µ–Ω–æ ‚úÖ

## üìÇ –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã:
- `bot/database/operations.py` - –æ—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

---

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ–ª–µ–µ —á–∏—Å—Ç–∞—è –∏ –Ω–∞–¥–µ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—É–ª–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö! üöÄ
